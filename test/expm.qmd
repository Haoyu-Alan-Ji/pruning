---
title: "My document"
author: "Haoyu Ji-jih20"
format: 
  html:
    self-contained: true
date: today
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
setwd(here::here())
```

```{r pkgs, message = FALSE, warning=FALSE}
library(Matrix)
library(ape)
library(tidyverse); theme_set(theme_bw())
library(waldo)
library(expm)
```

```{r seed}
set.seed(427)
```

```{r order compare}
m3 <- rtree(10)
par(mfrow=c(2,2))
head(m3$edge)
head(reorder(m3, "pruningwise")$edge)
head(reorder(m3, "postorder")$edge)

## is postorder == pruningwise in reverse??
head(reorder(m3, "postorder")$edge[18:1,])

## why do these all look identical??
plot(m3)
plot(reorder(m3, "pruningwise"))
tiplabels()
nodelabels()
plot(reorder(m3, "cladewise"))
tiplabels()
nodelabels()
plot(reorder(m3, "postorder"))
tiplabels()
nodelabels()

identical(m3, reorder(m3, "pruningwise"))

compare(m3, reorder(m3, "pruningwise"))
```


```{r fail test, eval = FALSE}
edge1 <- matrix(c(
  5, 3,
  3, 1,
  3, 2,
  5, 4
), byrow = TRUE, ncol = 2)

tip.label <- c("t1", "t2", "t3")

edge.length <- rep(1, nrow(edge1))

Nnode <- 2

tree <- list(edge = edge1,
             tip.label = tip.label,
             edge.length = edge.length,
             Nnode = Nnode)
class(tree) <- "phylo"

plot(tree, type = "phylogram", show.node.label = TRUE,  edge.width = 2, cex = 0.8)
tiplabels()
nodelabels()

str(tree)
is.binary(tree)
is.rooted(tree)
is.ultrametric(tree)
```

```{r}
# 3 tips tree
tree <- read.tree(text = "((t1:0.1,t2:0.2):0.3,t3:0.5);")
plot(tree, show.node.label = TRUE)

# 2*2 q
q01 <- 1.2
q10 <- 0.5
Q <- matrix(c(-1.2, 1.2,
              0.5, -0.5), nrow = 2, byrow = TRUE)

# set t1 = state 0, t2 = state 1, t3 = state 0
liks <- matrix(0, nrow = Ntip(tree) + tree$Nnode, ncol = 2)
liks[1, ] <- c(1, 0)  # t1
liks[2, ] <- c(0, 1)  # t2
liks[3, ] <- c(1, 0)  # t3

# calculate by pruninwise order
tree <- reorder(tree, "pruningwise")
comp <- numeric(nrow(liks))
anc <- unique(tree$edge[, 1])
for (focal in anc) {
  desRows <- which(tree$edge[, 1] == focal)
  desNodes <- tree$edge[desRows, 2]
  v <- 1
  for (d in seq_along(desRows)) {
    t <- tree$edge.length[desRows[d]]
    P <- expm(Q * t)
    v <- v * (P %*% liks[desNodes[d], ])
  }
  comp[focal] <- sum(v)
  liks[focal, ] <- v / comp[focal]
}

#loglik
TIPS <- 1:Ntip(tree)
root <- Ntip(tree) + 1
root.p <- rep(0.5, 2)
loglik <- sum(log(comp[-TIPS])) + log(sum(root.p * liks[root, ]))

neg_loglik <- -loglik
cat("Log-likelihood:", loglik, "\n")
cat("Negative log-likelihood:", neg_loglik, "\n")

```

$$
\log L = \sum_{\text{internal}} \log(\text{comp}) + \log\left( \sum_k \pi_k \cdot L_{\text{root},k} \right)
$$

```{r}
load("../data/primates.rda")
p1 <- primate.tree1
plot(reorder(p1, "pruningwise"))
tiplabels()
nodelabels()

# 2*2 q
q01 <- 1.2
q10 <- 0.5
Q <- matrix(c(-1.2, 1.2,
              0.5, -0.5), nrow = 2, byrow = TRUE)


liks <- matrix(NA, nrow = Ntip(p1) + p1$Nnode, ncol = 2)
liks[1, ] <- c(1, 0)
liks[2, ] <- c(0, 1)
liks[3, ] <- c(1, 0)
liks[4, ] <- c(1, 0)
liks[5, ] <- c(0, 1)
liks[6, ] <- c(1, 0)
liks[7, ] <- c(1, 0)
liks[8, ] <- c(0, 1)
# liks[9, ] <- c(1, 0)
# liks[10, ] <- c(1, 0)
# liks[11, ] <- c(0, 1)
# liks[12, ] <- c(1, 0)
# liks[13, ] <- c(1, 0)
# liks[14, ] <- c(0, 1)
# liks[15, ] <- c(1, 0)

# calculate by pruninwise order
p1 <- reorder(p1, "pruningwise")
comp <- numeric(nrow(liks))
anc <- unique(p1$edge[, 1])
for (i in anc) {
  desRows <- which(p1$edge[, 1] == i)
  desNodes <- p1$edge[desRows, 2]
  v <- 1
  for (d in seq_along(desRows)) {
    t <- p1$edge.length[desRows[d]]
    P <- expm(Q * t)
    v <- v * (P %*% liks[desNodes[d], ])
  }
  comp[i] <- sum(v)
  liks[i, ] <- v / comp[i]
}

#loglik
TIPS <- 1:Ntip(p1)
root <- Ntip(p1) + 1
root.p <- rep(0.5, 2)
loglik <- sum(log(comp[-TIPS])) + log(sum(root.p * liks[root, ]))

neg_loglik <- -loglik

```

