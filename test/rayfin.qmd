---
title: "parametric bootstrap in real data"
author: "Haoyu Ji"
format: 
  html:
    self-contained: true
date: today
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
setwd(here::here())
```

```{r pkgs, message = FALSE, warning=FALSE}
## https://github.com/bbolker/corHMM/blob/bolker_clean/misc/test_RTMB.R
## remotes::install_github("bbolker/corHMM", ref = "bolker_clean")
library(Matrix)
library(ape)
library(tidyverse); theme_set(theme_bw())
library(expm)
library(RTMB)
```

```{r seed}
set.seed(427)
```

```{r funs}
source(here::here("R", "Q_template.R"))
source(here::here("R", "getinfo.R"))
```

```{r realdat}
fish_traits <- read.csv(here::here('data', "binaryTraitData.csv"))
fish_tree   <- readRDS(here::here('data', "treeSingle.rds"))
```

```{r}
simfun(ntaxa = 8)
```


```{r clean43traits}
ctraits <- fish_traits[fish_traits$species %in% fish_tree$tip.label, ]

ctraits <- ctraits[match(fish_tree$tip.label, ctraits$species), ]

c_traits <- data.frame(
  Species = ctraits$species,
  ag = ctraits$ag,
  care = ctraits$care,
  spawning = ctraits$spawning
)

c_traits <- c_traits[!is.na(c_traits$care) & !is.na(c_traits$spawning), ]
c_tree <- drop.tip(fish_tree, setdiff(fish_tree$tip.label, c_traits$Species))

c_traits <- c_traits[match(c_tree$tip.label, c_traits$Species), ]
```


```{r}
base_orig <- corHMM(phy = c_tree, data = c_traits, rate.cat = 1)
base_RTMB <- corHMM(phy = c_tree, data = c_traits, rate.cat = 1, use_RTMB = TRUE)
```

```{r}
sample_subtree <- function(tree, traits, ntaxa) {
  
  if (ntaxa > Ntip(tree)) {
    stop("ntaxa is greater than nodes")
  }
  
  keep_tips <- sample(tree$tip.label, ntaxa)
  
  sub_tree <- drop.tip(tree, setdiff(tree$tip.label, keep_tips))
  
  sub_traits <- traits[traits$Species %in% sub_tree$tip.label, ]
  sub_traits <- sub_traits[match(sub_tree$tip.label, sub_traits$Species), ]
  
  stopifnot(all(sub_tree$tip.label == sub_traits$Species))
  
  list(tree = sub_tree, traits = sub_traits)
}
```


```{r}
o1 <- sample_subtree(c_tree, c_traits, 50)
```

```{r}
base_orig <- corHMM(phy = o1$tree, data = o1$traits, rate.cat = 1)
base_RTMB <- corHMM(phy = o1$tree, data = o1$traits, rate.cat = 1, use_RTMB = TRUE)
```


```{r}

```