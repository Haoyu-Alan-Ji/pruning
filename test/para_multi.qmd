---
title: "multistart test"
author: "Haoyu Ji"
format: 
  html:
    self-contained: true
date: today
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
setwd(here::here())
```

```{r pkgs, message = FALSE, warning=FALSE}
## https://github.com/bbolker/corHMM/blob/bolker_clean/misc/test_RTMB.R
## remotes::install_github("bbolker/corHMM", ref = "bolker_clean")
library(Matrix)
library(ape)
library(tidyverse); theme_set(theme_bw())
library(expm)
library(RTMB)
library(future.apply)
library(rstream)
library(parallel)
```

```{r seed}
set.seed(427)
```

```{r funs}
source(here::here("R", "Q_template.R"))
source(here::here("R", "getinfo.R"))
```

```{r 2trait, eval=FALSE}
ntaxvec <- as.numeric(5:200)
dd <- expand.grid(seed = 27, ntaxa = ntaxvec, ntrait = 2, model = c("ARD", "SYM"), rate.cat = 1) |>
  transform(model = as.character(model)) ## factor messes up do.call, converts to numeric

res <- list()
for (i in 1:nrow(dd)) {
  cat(sprintf("\rRunning %d/%d", i, nrow(dd)))
  flush.console()
  res[[i]] <- do.call(sumfun, dd[i,])
  saveRDS(res, file = here::here('data', 'para1.rds'))
}
res <- do.call(rbind, res)
saveRDS(res, file = here::here('data', 'para1.rds'))
```

```{r trait2plot}
## exploring differences ...
dd <- readRDS(here::here("data", "para1.rds"))
if (!is.data.frame(dd)) dd <- as.data.frame(t(dd))

with(dd, summary(as.numeric(RTMB_loglik)-as.numeric(orig_loglik)))
dd_diff <- dd |>
  mutate(ldiff = as.numeric(RTMB_loglik)-as.numeric(orig_loglik)) |>
  arrange(ldiff) |>
  mutate(n = seq(n()))

## filter(dd2, ldiff<0) |> View()

ggplot(dd_diff, aes(n, ldiff)) + geom_point()

dd_ARD <- dd_diff |>
  filter(model == 'ARD')
ggplot(dd_ARD, aes(ntaxa, ldiff)) + geom_point()

dd_SYM <- dd_diff |>
  filter(model == 'SYM')
ggplot(dd_SYM, aes(ntaxa, ldiff)) + geom_point()

cneg <- dd_diff |> filter(ldiff < 0) |> slice_max(ldiff, n = 1, with_ties = FALSE)
cpos <- dd_diff |> filter(ldiff > 0) |> slice_min(ldiff, n = 1, with_ties = FALSE)
c(cneg$ntaxa, cpos$ntaxa)
```


```{r 3trait, eval=FALSE}
ntaxvec <- as.numeric(20:200)
dd <- expand.grid(seed = 27, ntaxa = ntaxvec, ntrait = 3, model = c("ARD", "SYM"), rate.cat = 1) |>
  transform(model = as.character(model)) ## factor messes up do.call, converts to numeric

res <- list()
for (i in 1:nrow(dd)) {
  cat(sprintf("\rRunning %d/%d", i, nrow(dd)))
  flush.console()
  res[[i]] <- do.call(sumfun, dd[i,])
  saveRDS(res, file = here::here('data', 'trait3.rds'))
}
res <- do.call(rbind, res)
saveRDS(res, file = here::here('data', 'trait3.rds'))
```

```{r trait3plot}
## exploring differences ...
dd <- readRDS(here::here("data", "trait3.rds"))
if (!is.data.frame(dd)) dd <- as.data.frame(t(dd))

with(dd, summary(as.numeric(RTMB_loglik)-as.numeric(orig_loglik)))
dd_diff <- dd |>
  mutate(ldiff = as.numeric(RTMB_loglik)-as.numeric(orig_loglik)) |>
  arrange(ldiff) |>
  mutate(n = seq(n()))

## filter(dd2, ldiff<0) |> View()

ggplot(dd_diff, aes(n, ldiff)) + geom_point()

dd_ARD <- dd_diff |>
  filter(model == 'ARD')
ggplot(dd_ARD, aes(ntaxa, ldiff)) + geom_point()

dd_SYM <- dd_diff |>
  filter(model == 'SYM')
ggplot(dd_SYM, aes(ntaxa, ldiff)) + geom_point()

cneg <- dd_diff |> filter(ldiff < 0) |> slice_max(ldiff, n = 1, with_ties = FALSE)
cpos <- dd_diff |> filter(ldiff > 0) |> slice_min(ldiff, n = 1, with_ties = FALSE)
c(cneg$ntaxa, cpos$ntaxa)
```

```{r 4trait, eval=FALSE}
ntaxvec <- as.numeric(35:100)
dd <- expand.grid(seed = 27, ntaxa = ntaxvec, ntrait = 4, model = c("ARD", "SYM"), rate.cat = 1) |>
  transform(model = as.character(model)) ## factor messes up do.call, converts to numeric

res <- list()
for (i in 1:nrow(dd)) {
  cat(sprintf("\rRunning %d/%d", i, nrow(dd)))
  flush.console()
  res[[i]] <- do.call(sumfun, dd[i,])
  saveRDS(res, file = here::here('data', 'trait4.rds'))
}
res <- do.call(rbind, res)
saveRDS(res, file = here::here('data', 'trait4.rds'))
```

```{r trait4plot}
## exploring differences ...
dd <- readRDS(here::here("data", "trait4.rds"))
if (!is.data.frame(dd)) dd <- as.data.frame(t(dd))

with(dd, summary(as.numeric(RTMB_loglik)-as.numeric(orig_loglik)))
dd_diff <- dd |>
  mutate(ldiff = as.numeric(RTMB_loglik)-as.numeric(orig_loglik)) |>
  arrange(ldiff) |>
  mutate(n = seq(n()))

## filter(dd2, ldiff<0) |> View()

ggplot(dd_diff, aes(n, ldiff)) + geom_point()

dd_ARD <- dd_diff |>
  filter(model == 'ARD')
ggplot(dd_ARD, aes(ntaxa, ldiff)) + geom_point()

dd_SYM <- dd_diff |>
  filter(model == 'SYM')
ggplot(dd_SYM, aes(ntaxa, ldiff)) + geom_point()

cneg <- dd_diff |> filter(ldiff < 0) |> slice_max(ldiff, n = 1, with_ties = FALSE)
cpos <- dd_diff |> filter(ldiff > 0) |> slice_min(ldiff, n = 1, with_ties = FALSE)
c(cneg$ntaxa, cpos$ntaxa)
```